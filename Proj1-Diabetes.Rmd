---
title: "Project1 - Diabetes dataset analysis"
author: "Shuyi Li"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    toc: yes
  html_document:
    code_folding: show
    toc: yes
---

## Dependencies

```{r, message=FALSE, eval=TRUE}
library(dplyr)
library(ggplot2)
library(ggfortify)
library(Hmisc)
library(factoextra)
library(pca3d)
library(rgl)
library(Rtsne)
library(ggcorrplot)
```

## Data info

[Data Sources] (https://search.r-project.org/CRAN/refmans/mlbench/html/PimaIndiansDiabetes.html)

### Check the data structure
```{r}
# import raw data
diabetes <- read.csv('diabetes.csv',header = T)
# replace 0 with NA
var_with_NAs <- c("Glucose","BloodPressure","SkinThickness","Insulin","BMI","Age")
for (i in var_with_NAs){
  diabetes[[i]][diabetes[[i]] == 0] <- NA
}
diabetes$Outcome[diabetes$Outcome == 0] <- 'healthy'
diabetes$Outcome[diabetes$Outcome == 1] <- 'diabetes'
# turn the outcome variable into factor
diabetes$Outcome <- as.factor(diabetes$Outcome)
# check the data structure
str(diabetes)
# Remove NA rows
diabetes <-diabetes %>% na.omit()
dim(diabetes)
```
After remove the NA values, the samples number reduced from 768 to 392

### Data preview

```{r}
knitr::kable(head(diabetes))
diabetes_lm <- diabetes[, -9]
## subset based on diabetes or healthy samples
diabetes_sub <- diabetes_lm[diabetes$Outcome %in% "diabetes",]
healthy_sub <- diabetes_lm[diabetes$Outcome %in% "healthy",]
```

## Data initial inspection

### Scatter plot

```{r, fig.height = 10, fig.width = 13}
pairs(~Pregnancies + Glucose + BloodPressure + SkinThickness + Insulin + BMI + DiabetesPedigreeFunction + Age,
      col = diabetes$Outcome, data = diabetes)
```

### Histogram

```{r,fig.width = 13}
par(mfrow=c(2,4))
for (i in colnames(diabetes_lm)){
  hist(diabetes_lm[[i]], main = i, xlab = NULL)
}

histogram <- function(x,y){
  p1 <- hist(x,col=rgb(0,0,1,1/4), main = i, xlab = NULL, xlim = range(x))
  p2 <- hist(y,col=rgb(1,0,0,1/4),ylim = range(y), add=T)
  legend ("topright", legend = c("healthy","diabetes"),
          fill = c(rgb(0,0,1,1/4),rgb(1,0,0,1/4)), cex = 0.8)
}

par(mfrow=c(2,4))
for (i in colnames(diabetes_lm)){
  histogram(healthy_sub[[i]], diabetes_sub[[i]])
}
```
We can see from the histogram that some variables have a high skewness. So we do a log2 transform for some variables.

```{r, fig.width = 13}
diabetes_lm$Glucose <- log2(diabetes_lm$Glucose)
diabetes_lm$Insulin <- log2(diabetes_lm$Insulin)
diabetes_lm$BMI <- log2(diabetes_lm$BMI)
diabetes_lm$DiabetesPedigreeFunction <- log2(diabetes_lm$DiabetesPedigreeFunction)

par(mfrow=c(2,4))
for (i in colnames(diabetes_lm)){
  hist(diabetes_lm[[i]], main = i, xlab = NULL)
}

par(mfrow=c(2,4))
for (i in colnames(diabetes_lm)){
  histogram(healthy_sub[[i]], diabetes_sub[[i]])
}
```

### Q-Q plot

```{r,fig.width = 13}
par(mfrow=c(2,4))
for (i in colnames(diabetes_lm)){
  qqnorm(diabetes_lm[[i]], main = i);qqline(diabetes_lm[[i]], col = "red", lwd = 2)
}
```

### Box plot

```{r,fig.width = 13,fig.height = 7}

par(mfrow=c(2,4))
for (i in colnames(diabetes_lm)){
  boxplot(diabetes_lm[[i]] ~ diabetes[["Outcome"]], data = diabetes, main = i, xlab = NULL, ylab = NULL, col = c(rgb(1,0,0,1/4), rgb(0,0,1,1/4)))
}
```

### Student t-test

```{r}
t_test <- function (x,y) {
  var_test <- var.test(x, y, alternative = "two.sided")
  if (var_test$p.value < 0.05 & abs(var_test$estimate) < 1.1) {
     t.test(x, y, paired = FALSE, var.equal = TRUE, conf.level = 0.95)
  }
  else {
     t.test(x, y, paired = FALSE, var.equal = FALSE, conf.level = 0.95)
  }
}
```


```{r}
t_test(diabetes_sub$Glucose, healthy_sub$Glucose)
```


```{r}
t_test(diabetes_sub$BloodPressure, healthy_sub$BloodPressure)
```


```{r}
t_test(diabetes_sub$SkinThickness, healthy_sub$SkinThickness)
```


```{r}
t_test(diabetes_sub$Insulin, healthy_sub$Insulin)
```


```{r}
t_test(diabetes_sub$DiabetesPedigreeFunction, healthy_sub$DiabetesPedigreeFunction)
```


```{r}
t_test(diabetes_sub$BMI, healthy_sub$BMI)
```

### Correlation analysis

```{r}
diabetes_lm_1 <- diabetes_lm[, -c(1,8)]
cor_res_pea <- rcorr(as.matrix(diabetes_lm_1), type = "pearson")
knitr::kable(cor_res_pea$r)
ggcorrplot(cor_res_pea$r)
```


```{r}
diabetes_cor <- read.csv('diabetes.csv',header = T)
cor_res_spe <- rcorr(as.matrix(diabetes_cor), type = "spearman")
knitr::kable(cor_res_spe$r)
ggcorrplot(cor_res_spe$r)
```

### Simple linear regression

```{r}
# function to make a pairwise linear regression between each variables
pairwise_lm <- function (dat) {
  n <- nrow(dat)
  p <- ncol(dat)
  LHS <- rep(colnames(dat), p)
  RHS <- rep(colnames(dat), each = p)
  ## function to fit and summarize a single model
  fitmodel <- function (LHS, RHS) {
    if (RHS == LHS) {
      z <- data.frame("LHS" = LHS, "RHS" = RHS,
                      "alpha" = 0,
                      "beta" = 1,
                      "beta.se" = 0,
                      "beta.tv" = Inf,
                      "beta.pv" = 0,
                      "sig" = 0,
                      "R2" = 1,
                      "F.fv" = Inf,
                      "F.pv" = 0,
                      stringsAsFactors = FALSE)
      } else {
      result <- summary(lm(reformulate(RHS, LHS), data = dat))
      z <- data.frame("LHS" = LHS, "RHS" = RHS,
                      "alpha" = result$coefficients[1, 1],
                      "beta" = result$coefficients[2, 1],
                      "beta.se" = result$coefficients[2, 2],
                      "beta.tv" = result$coefficients[2, 3],
                      "beta.pv" = result$coefficients[2, 4],
                      "sig" = result$sigma,
                      "R2" = result$r.squared,
                      "F.fv" = result$fstatistic[[1]],
                      "F.pv" = pf(result$fstatistic[[1]], 1, n - 2, lower.tail = FALSE),
                      stringsAsFactors = FALSE)
        }
      z
      }
  ## loop through all models
  do.call("rbind.data.frame", c(Map(fitmodel, LHS, RHS),
                                list(make.row.names = FALSE,
                                     stringsAsFactors = FALSE)))
  }
```

```{r}
# perform pairwise linear regression
diabetes_lm_res <- pairwise_lm(diabetes_lm_1)
knitr::kable(diabetes_lm_res)
```

## Exploratory data analysis

### Principal component analysis

```{r, message=FALSE, eval=TRUE}
pca_res <- prcomp(diabetes_lm,scale. = TRUE)
autoplot(pca_res, data = diabetes, colour = 'Outcome',
         frame = TRUE, frame.type = 'norm', shape = FALSE, label.size = 3)

## remove outliers
rows_remove <- c("446","121","178","618","255","520","29","460","461")
diabetes_lm_clean <- diabetes_lm[!(row.names(diabetes_lm) %in% rows_remove),]
diabetes_clean <- diabetes[!(row.names(diabetes) %in% rows_remove),]

## perform PCA again
pca_res <- prcomp(diabetes_lm_clean,scale. = TRUE)
autoplot(pca_res, data = diabetes_clean, colour = 'Outcome',
         frame = TRUE, frame.type = 'norm', shape = FALSE, label.size = 3)
autoplot(pca_res, data = diabetes_clean, colour = 'Outcome',
         loadings = TRUE,loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 3)

## check scree plot and Q-Q plot
pca_res %>% fviz_eig()
pca_res %>% get_eig()
pca_res %>% fviz_eig(choice = "eigenvalue",
             geom = "line",
             addlabels = T) +
             scale_y_continuous(limits = c(0, 5))
pca_res[["x"]][,1] %>% qqnorm()
```


```{r, message=FALSE, eval=TRUE}
# ellipses
pca3d(pca_res, group=diabetes_clean$Outcome, show.ellipses=TRUE, ellipse.ci=0.75,      show.plane=FALSE)
# loading
pca3d(pca_res, group=diabetes_clean$Outcome, show.plane=TRUE , biplot = TRUE, biplot.vars = 8)
```
#### 3D PCA plot
<video width="420" height="340" controls>
  <source src="PCA_3D.mp4" type="video/mp4">
</video>
#### 3D PCA biplot
<video width="420" height="340" controls>
  <source src="PCAbiplot_3D.mp4" type="video/mp4">
</video>

### Maximum-likelihood factor analysis

```{r}
factor_res <- factanal(diabetes_lm, factors = 3, scores = 'regression')
autoplot(factor_res, data = diabetes, colour = 'Outcome',loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3)
```

### t-SNE analysis

```{r,message=FALSE, eval=TRUE}
tsne_out <- Rtsne(diabetes_lm, perplexity = 20)
pdat <- data.frame(tsne_out$Y, diabetes$Outcome)
colnames(pdat) = c("Y1", "Y2", "group")
ggplot(pdat,aes(Y1,Y2))+
  geom_point(aes(Y1,Y2, fill = group),shape = 21, color = "black") +
             stat_ellipse(aes(color = group, fill = group),
                          geom = "polygon",
                          alpha = 0.3,
                          linetype = 2)+
             theme_classic() +
             theme(legend.position = "top")
```
